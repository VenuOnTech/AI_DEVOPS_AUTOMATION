name: AI DevOps CI/CD Pipeline

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'ai/deployment_history.csv'
      - 'ai/deployment_model.pkl'

permissions:
  contents: write

concurrency:
  group: ai-devops-deploy
  cancel-in-progress: false

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    env:
      ACR_NAME: venudadiprojectacr001.azurecr.io
      IMAGE_NAME: ai-devops
      APP_NAME: tf-ai-devops-app
      RESOURCE_GROUP: ai-devops-rg
      RISK_THRESHOLD: 0.85

    steps:

    # 1Ô∏è‚É£ Checkout
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # 2Ô∏è‚É£ Setup Python
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    # 3Ô∏è‚É£ Install Dependencies
    - name: Install AI Requirements
      run: |
        pip install --upgrade pip
        pip install -r ai/requirements.txt

    # 4Ô∏è‚É£ Extract Deployment Features
    - name: Extract Deployment Features
      id: metrics
      run: |
        if git rev-parse HEAD~1 >/dev/null 2>&1; then
          LINES_CHANGED=$(git diff --shortstat HEAD~1 | awk '{print $4}')
          FILES_CHANGED=$(git diff --name-only HEAD~1 | wc -l)
        else
          LINES_CHANGED=0
          FILES_CHANGED=0
        fi

        COMMIT_MESSAGE_LENGTH=$(git log -1 --pretty=%B | wc -m)

        if [ "$LINES_CHANGED" -eq 0 ]; then
          CHURN_RATE=0
        else
          CHURN_RATE=$(echo "$FILES_CHANGED $LINES_CHANGED" | awk '{print $1/$2}')
        fi

        echo "LINES_CHANGED=${LINES_CHANGED:-0}" >> $GITHUB_ENV
        echo "FILES_CHANGED=${FILES_CHANGED:-0}" >> $GITHUB_ENV
        echo "COMMIT_MESSAGE_LENGTH=${COMMIT_MESSAGE_LENGTH:-0}" >> $GITHUB_ENV
        echo "CHURN_RATE=${CHURN_RATE:-0}" >> $GITHUB_ENV

    # 5Ô∏è‚É£ Train Model FIRST (important for learning)
    - name: Train ML Model
      run: |
        python ai/train_model.py

    # 6Ô∏è‚É£ AI Risk Prediction
    - name: AI Risk Prediction
      id: risk
      run: |
        RISK=$(python ai/risk_model.py \
          $LINES_CHANGED \
          $FILES_CHANGED \
          $COMMIT_MESSAGE_LENGTH \
          $CHURN_RATE)

        echo "Predicted Risk Score: $RISK"

        echo "RISK_SCORE=$RISK" >> $GITHUB_ENV

        if (( $(echo "$RISK > $RISK_THRESHOLD" | bc -l) )); then
          echo "BLOCK_DEPLOYMENT=true" >> $GITHUB_ENV
        else
          echo "BLOCK_DEPLOYMENT=false" >> $GITHUB_ENV
        fi

    # 7Ô∏è‚É£ Hard Stop Only for Very High Risk
    - name: Stop If High Risk
      if: env.BLOCK_DEPLOYMENT == 'true'
      run: |
        echo "High risk detected (>$RISK_THRESHOLD). Logging failure."
        python ai/deployment_logger.py \
          $LINES_CHANGED \
          $FILES_CHANGED \
          $COMMIT_MESSAGE_LENGTH \
          $CHURN_RATE \
          1
        exit 1

    # 8Ô∏è‚É£ Login to ACR
    - name: Login to ACR
      if: env.BLOCK_DEPLOYMENT == 'false'
      uses: docker/login-action@v3
      with:
        registry: ${{ env.ACR_NAME }}
        username: ${{ secrets.ACR_USERNAME }}
        password: ${{ secrets.ACR_PASSWORD }}

    # 9Ô∏è‚É£ Build Image
    - name: Build Docker Image
      if: env.BLOCK_DEPLOYMENT == 'false'
      run: |
        docker build -t $ACR_NAME/$IMAGE_NAME:${{ github.run_number }} .
        docker tag $ACR_NAME/$IMAGE_NAME:${{ github.run_number }} $ACR_NAME/$IMAGE_NAME:latest

    # üîü Push Image
    - name: Push Docker Image
      if: env.BLOCK_DEPLOYMENT == 'false'
      run: |
        docker push $ACR_NAME/$IMAGE_NAME:${{ github.run_number }}
        docker push $ACR_NAME/$IMAGE_NAME:latest

    # 1Ô∏è‚É£1Ô∏è‚É£ Azure Login
    - name: Azure Login
      if: env.BLOCK_DEPLOYMENT == 'false'
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    # 1Ô∏è‚É£2Ô∏è‚É£ Update Web App Container
    - name: Update Azure Web App
      if: env.BLOCK_DEPLOYMENT == 'false'
      run: |
        az webapp config container set \
          --name $APP_NAME \
          --resource-group $RESOURCE_GROUP \
          --container-image-name $ACR_NAME/$IMAGE_NAME:latest \
          --container-registry-url https://$ACR_NAME \
          --container-registry-user ${{ secrets.ACR_USERNAME }} \
          --container-registry-password ${{ secrets.ACR_PASSWORD }}

    # 1Ô∏è‚É£3Ô∏è‚É£ Restart Web App
    - name: Restart Web App
      if: env.BLOCK_DEPLOYMENT == 'false'
      run: |
        az webapp restart \
          --name $APP_NAME \
          --resource-group $RESOURCE_GROUP

    # 1Ô∏è‚É£4Ô∏è‚É£ Log Successful Deployment
    - name: Log Successful Deployment
      if: env.BLOCK_DEPLOYMENT == 'false'
      run: |
        python ai/deployment_logger.py \
          $LINES_CHANGED \
          $FILES_CHANGED \
          $COMMIT_MESSAGE_LENGTH \
          $CHURN_RATE \
          0

    # 1Ô∏è‚É£5Ô∏è‚É£ Commit Dataset (Safe Commit)
    - name: Commit Updated Dataset
      run: |
        git config user.name "github-actions"
        git config user.email "actions@github.com"

        git add ai/deployment_history.csv || true
        git add ai/deployment_model.pkl || true

        git diff --cached --quiet || git commit -m "Auto-update deployment dataset"

        git pull --rebase origin main || true
        git push || true
